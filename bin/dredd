#!/usr/bin/env node
var optimist = require('optimist');
var parsePackageJson = require('../lib/parsePackageJson');
var path = require('path');
var Dredd = require('../lib/dredd');

var version = parsePackageJson(path.join(__dirname, '../package.json'));

var argv = optimist
    .usage("dredd <path to blueprint> <api_endpoint> [OPTIONS]"
     + "\n\nExample: \n  " + "dredd ./apiary.md http://localhost:3000 --dry-run")
    .options(Dredd.options)
    .wrap(80)
    .version(version, 'version', 'Show version number')
    .help('help', 'Show usage information')
    .argv;

var argError = false;

if (argv._[0] == undefined) {
  console.error("Error: Must specify path to blueprint file.");
  argError = true;
}
if (argv._[1] == undefined) {
  console.error("Error: Must specify api endpoint.");
  argError = true;
}
if (argError) {
  console.error("\n")
  optimist.showHelp(fn=console.error);
  process.exit(1);
};

configuration = {
  'blueprintPath': argv._[0],
  'server': argv._[1],
  'options': argv
}

dredd = new Dredd(configuration);

dredd.run(function(error, stats){
  if (error) {
   console.error(error.stack);
  }
  if (stats.failures + stats.errors > 0) {
    process.exit(1);
  } else {
    process.exit(0);
  };
});
